# í†µí•© CI/CD ì›Œí¬í”Œë¡œìš°
name: CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled]
    branches: [ main, master ]
  release:
    types: [created]

jobs:
  # ì½”ë“œ ë¦¬ë·° (ë³´ì•ˆ ì œí•œ ì ìš©)
  code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    # ë³¸ì¸ë§Œ ìë™ ì‹¤í–‰, ì™¸ë¶€ PRì€ ìŠ¹ì¸ ë¼ë²¨ í•„ìš”
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && (
        github.event.pull_request.user.login == 'chimaek' ||
        contains(github.event.pull_request.labels.*.name, 'code-review-approved')
      ))
    permissions:
      contents: read
      pull-requests: write
      issues: write
      # commit commentsëŠ” ê¸°ë³¸ í† í°ìœ¼ë¡œ ê¶Œí•œ ì—†ìŒ - push ì´ë²¤íŠ¸ëŠ” ë¡œê·¸ë§Œ ì¶œë ¥
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js for build
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Build action for self-test
      run: |
        npm ci
        npm run build
    
    - name: Self Code Review
      uses: ./
      with:
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        review_type: full
        language: ko
        file_patterns: "**/*.js,**/*.ts,**/*.jsx,**/*.tsx,**/*.py,**/*.java,**/*.go,**/*.rs"
        exclude_patterns: "dist/**,node_modules/**,test/**"
        max_files: 8
        severity_filter: medium
      continue-on-error: true

  # ì™¸ë¶€ PR ë³´ì•ˆ ì•Œë¦¼
  security-check:
    name: External PR Security Check
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      github.event.pull_request.user.login != 'chimaek' &&
      !contains(github.event.pull_request.labels.*.name, 'code-review-approved')
    permissions:
      issues: write
      pull-requests: write
    
    steps:
    - name: Security warning for external PR
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.issue.number;
          const prAuthor = context.payload.pull_request.user.login;
          
          await github.rest.issues.createComment({
            issue_number: prNumber,
            owner: owner,
            repo: repo,
            body: `ğŸ”’ **ì™¸ë¶€ ê¸°ì—¬ì PR ê°ì§€ / External Contributor PR Detected**
            
            @${prAuthor}ë‹˜ì˜ PRì´ ì™¸ë¶€ ê¸°ì—¬ìë¡œ ë¶„ë¥˜ë˜ì–´ ìë™ ì½”ë“œ ë¦¬ë·°ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            **ë¦¬í¬ì§€í† ë¦¬ ê´€ë¦¬ìì—ê²Œ:**
            - [ ] ì½”ë“œì— ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ë‚˜ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ”ì§€ í™•ì¸
            - [ ] Secretsë‚˜ í™˜ê²½ë³€ìˆ˜ì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œê°€ ì—†ëŠ”ì§€ í™•ì¸  
            - [ ] íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ ì½”ë“œ ê²€í† 
            - [ ] ê²€í†  ì™„ë£Œ í›„ \`code-review-approved\` ë¼ë²¨ ì¶”ê°€í•˜ì—¬ AI ë¦¬ë·° í™œì„±í™”
            
            **External contributor detected.** Auto code review disabled for security.
            **Repository maintainer:** Review code manually, then add \`code-review-approved\` label to enable AI review.`
          });

  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build
      run: npm run build
    
    - name: Verify build
      run: |
        if [ ! -f "dist/index.js" ]; then
          echo "Build failed: dist/index.js not found"
          exit 1
        fi
        echo "Build successful"

  # main ë¸Œëœì¹˜ push ì‹œ dist ìë™ ì—…ë°ì´íŠ¸
  update-dist:
    name: Update dist
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Build and commit
      run: |
        npm ci
        npm run build
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        if ! git diff --quiet dist/; then
          git add dist/
          git commit -m "chore: update dist [skip ci]"
          git push
        fi

  # ë¦´ë¦¬ìŠ¤ ìƒì„± ì‹œ ìë™ ë°°í¬
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Build for release
      run: |
        npm ci
        npm run build
    
    - name: Update release assets
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // dist.zip ìƒì„±
          const { execSync } = require('child_process');
          execSync('zip -r dist.zip dist/');
          
          // ë¦´ë¦¬ìŠ¤ì— dist.zip ì¶”ê°€
          const release = context.payload.release;
          await github.rest.repos.uploadReleaseAsset({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release.id,
            name: 'dist.zip',
            data: fs.readFileSync('dist.zip')
          });