name: Claude AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  # í‘¸ì‹œ ì´ë²¤íŠ¸ë„ íŠ¹ì • ì‚¬ìš©ìë§Œ í—ˆìš©
  push:
    branches: [main, master]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    # ë³¸ì¸ë§Œ ìë™ ì‹¤í–‰, ë‹¤ë¥¸ ì‚¬ìš©ìëŠ” ìŠ¹ì¸ ë¼ë²¨ í•„ìš”
    if: |
      github.event_name == 'push' ||
      github.event.pull_request.user.login == 'pipir' ||
      contains(github.event.pull_request.labels.*.name, 'code-review-approved')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Run Claude Code Review
        uses: ./
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          review_type: full
          language: ko
          max_files: 8
          severity_filter: medium
          
      - name: Add comment for external PRs
        if: |
          github.event_name == 'pull_request' &&
          github.event.pull_request.user.login != 'pipir' &&
          !contains(github.event.pull_request.labels.*.name, 'code-review-approved')
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ¤– **Claude AI ì½”ë“œ ë¦¬ë·° ëŒ€ê¸° ì¤‘**
              
              ì™¸ë¶€ ê¸°ì—¬ìì˜ PRì…ë‹ˆë‹¤. ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ìë™ ì½”ë“œ ë¦¬ë·°ê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
              
              **ë¦¬í¬ì§€í† ë¦¬ ê´€ë¦¬ìì—ê²Œ:**
              - ì½”ë“œë¥¼ ê²€í† í•œ í›„ \`code-review-approved\` ë¼ë²¨ì„ ì¶”ê°€í•˜ë©´ AI ë¦¬ë·°ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
              - ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì½”ë“œë¥¼ ë¦¬ë·°í•´ì£¼ì„¸ìš”.
              
              **External contributor PR detected.** Auto code review is disabled for security.
              Repository maintainer: Add \`code-review-approved\` label to enable AI review.`
            })

  # ë³„ë„ ì¡ìœ¼ë¡œ ê¶Œí•œ ì²´í¬
  security-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR security
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const prAuthor = context.payload.pull_request.user.login;
            
            // í—ˆìš©ëœ ì‚¬ìš©ì ëª©ë¡
            const allowedUsers = ['pipir'];
            
            // ì¡°ì§ ë©¤ë²„ ì²´í¬ (ì„ íƒì‚¬í•­)
            try {
              const membership = await github.rest.orgs.getMembershipForUser({
                org: owner,
                username: prAuthor
              });
              
              if (membership.data.state === 'active') {
                console.log(`User ${prAuthor} is organization member`);
                return;
              }
            } catch (error) {
              console.log(`Not an organization or user not a member: ${error.message}`);
            }
            
            // í—ˆìš©ëœ ì‚¬ìš©ìê°€ ì•„ë‹Œ ê²½ìš° ê²½ê³  ì½”ë©˜íŠ¸
            if (!allowedUsers.includes(prAuthor)) {
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: owner,
                repo: repo,
                body: `âš ï¸ **ë³´ì•ˆ ì•Œë¦¼ / Security Notice**
                
                ì™¸ë¶€ ê¸°ì—¬ìì˜ PRì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬í•­ì„ í™•ì¸í•´ì£¼ì„¸ìš”:
                
                **ë¦¬í¬ì§€í† ë¦¬ ê´€ë¦¬ì ì²´í¬ë¦¬ìŠ¤íŠ¸:**
                - [ ] ì½”ë“œì— ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ë‚˜ ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ”ì§€ í™•ì¸
                - [ ] Secretsë‚˜ í™˜ê²½ë³€ìˆ˜ì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œê°€ ì—†ëŠ”ì§€ í™•ì¸  
                - [ ] íŒŒì¼ ì‹œìŠ¤í…œì— ì ‘ê·¼í•˜ê±°ë‚˜ ë„¤íŠ¸ì›Œí¬ ìš”ì²­ì„ í•˜ëŠ” ì½”ë“œ ê²€í† 
                - [ ] ê²€í†  ì™„ë£Œ í›„ \`code-review-approved\` ë¼ë²¨ ì¶”ê°€
                
                **External PR detected.** Please review for security before approving automated workflows.`
              });
            }